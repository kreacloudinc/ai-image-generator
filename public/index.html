<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Immagini AI - Upload</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Script di autenticazione -->
    <script>
        // Verifica autenticazione all'avvio
        (function() {
            const token = localStorage.getItem('authToken');
            
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            // Verifica validità del token
            fetch('/api/verify-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            }).then(response => response.json())
              .then(data => {
                  if (!data.valid) {
                      localStorage.removeItem('authToken');
                      window.location.href = '/login.html';
                  }
              }).catch(error => {
                  console.error('Errore verifica token:', error);
                  localStorage.removeItem('authToken');
                  window.location.href = '/login.html';
              });
        })();
        
        // Funzione di logout
        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/login.html';
        }
    </script>
    
    <div class="container">
        <div class="header-controls">
            <h1>🚀 Generatore Immagini AI</h1>
            <button onclick="logout()" class="logout-btn">
                🚪 Esci
            </button>
        </div>
        <div class="page-content">
            <h2>📷 Seleziona o Carica un'immagine</h2>
            <p>Scegli un'immagine esistente o carica la tua per la generazione AI</p>
            
            <!-- Sezione toggle per scegliere modalità -->
            <div class="mode-selector">
                <button type="button" id="uploadModeBtn" class="mode-btn active">
                    📤 Carica Nuova Immagine
                </button>
                <button type="button" id="cameraModeBtn" class="mode-btn">
                    📷 Scatta Foto
                </button>
                <button type="button" id="selectModeBtn" class="mode-btn">
                    🖼️ Scegli Immagine Esistente
                </button>
            </div>
            
            <!-- Sezione Upload (default) -->
            <div id="uploadSection" class="input-section">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">📸</div>
                        <p>Clicca per selezionare un'immagine<br>
                        <small>Formati supportati: JPG, PNG, GIF (max 5MB)</small></p>
                        <input type="file" id="imageInput" name="image" accept="image/*">
                    </div>
                    
                    <button type="submit" id="uploadBtn" disabled>
                        📤 Carica Immagine
                    </button>
                </form>
            </div>
            
            <!-- Sezione Camera (webcam) -->
            <div id="cameraSection" class="input-section hidden">
                <div class="camera-container">
                    <div class="camera-preview">
                        <video id="cameraVideo" autoplay playsinline></video>
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                    </div>
                    
                    <div class="camera-controls">
                        <button type="button" id="startCameraBtn" class="btn btn-primary">
                            📷 Avvia Camera
                        </button>
                        <button type="button" id="captureBtn" class="btn btn-secondary" disabled>
                            📸 Scatta Foto
                        </button>
                        <button type="button" id="retakeBtn" class="btn btn-secondary hidden">
                            🔄 Rifai Foto
                        </button>
                        <button type="button" id="useCameraPhotoBtn" class="btn btn-primary hidden">
                            ✅ Usa Questa Foto
                        </button>
                    </div>
                    
                    <div class="camera-preview-result hidden" id="cameraPreviewResult">
                        <img id="capturedImage" alt="Foto scattata">
                    </div>
                </div>
            </div>
            
            <!-- Sezione Selezione immagini esistenti -->
            <div id="selectSection" class="input-section hidden">
                <div class="existing-images">
                    <div class="images-grid" id="imagesGrid">
                        <!-- Le immagini verranno caricate dinamicamente -->
                    </div>
                    <div class="no-images hidden" id="noImages">
                        <p>📭 Nessuna immagine trovata nella cartella uploads</p>
                        <p><small>Carica prima alcune immagini per poterle selezionare</small></p>
                    </div>
                </div>
            </div>
            
            <!-- Galleria immagini generate -->
            <div class="generated-gallery">
                <h3>🎨 Galleria Immagini Generate</h3>
                <div class="gallery-grid" id="generatedGallery">
                    <!-- Le immagini generate verranno caricate dinamicamente -->
                </div>
                <div class="no-generated hidden" id="noGenerated">
                    <p>🖼️ Nessuna immagine generata ancora</p>
                    <p><small>Le immagini create dai modelli AI appariranno qui</small></p>
                </div>
            </div>
            
            <!-- Sezione Galleria Batch -->
            <div id="batchGallerySection" class="batch-gallery-section">
                <h2>🎨 Galleria Batch Completati</h2>
                <div id="batchGallery" class="batch-gallery">
                    <!-- I batch verranno caricati dinamicamente qui -->
                </div>
            </div>
            
            <!-- Loader durante upload -->
            <div id="loader" class="loader hidden">
                <div class="spinner"></div>
                <p>Caricamento in corso...</p>
            </div>
            
            <!-- Messaggio di errore -->
            <div id="errorMessage" class="error-message hidden"></div>
        </div>
    </div>
    
    <script src="upload.js"></script>
</body>
</html>
